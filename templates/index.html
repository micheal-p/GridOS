<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GridOS | Command Center</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <style>
        :root { --bg: #ffffff; --text: #1d1d1f; --gray: #f5f5f7; --green: #34C759; --brown: #A2845E; --red: #FF3B30; --orange: #FF9500; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; transition: background 0.3s; }
        
        body.blackout { background: #1a0000; --text: #ffcccc; --gray: #330000; }
        body.blackout .metric-card, body.blackout .map-section, body.blackout .header, body.blackout .panel { background: #330000; border-color: #550000; color: #fff; }
        
        .header { width: 100%; padding: 40px 0; background: radial-gradient(circle at center, #f9f9fa 0%, #fff 100%); border-bottom: 1px solid #eee; text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 42px; font-weight: 700; letter-spacing: -1.5px; margin: 0; }
        .header p { color: #86868b; font-size: 16px; margin-top: 5px; }
        
        .dashboard { display: grid; grid-template-columns: 320px 1fr; gap: 40px; width: 90%; max-width: 1400px; margin-bottom: 80px; }
        .panel { background: var(--gray); padding: 30px; border-radius: 24px; height: fit-content; }
        
        /* Tooltips */
        .info-icon { display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; border-radius: 50%; border: 1px solid #ccc; font-size: 10px; color: #888; margin-left: 6px; cursor: help; font-style: normal; }
        .info-icon:hover::after { content: attr(data-tooltip); position: absolute; background: #111; color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; width: 220px; line-height: 1.4; z-index: 100; transform: translateY(-30px); pointer-events: none; white-space: normal; text-align: left; }

        label { display: flex; align-items: center; font-size: 11px; font-weight: 700; color: #86868b; text-transform: uppercase; margin-bottom: 12px; }
        input[type="range"] { appearance: none; -webkit-appearance: none; width: 100%; background: #e0e0e0; height: 4px; border-radius: 2px; margin-bottom: 20px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: white; border-radius: 50%; box-shadow: 0 4px 8px rgba(0,0,0,0.15); cursor: pointer; border: 0.5px solid rgba(0,0,0,0.05); }
        select { width: 100%; padding: 14px 12px; border-radius: 12px; border: 1px solid #d1d1d6; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 30px; }
        button.run-btn { width: 100%; padding: 18px; background: #1d1d1f; color: white; border: none; border-radius: 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.1s; }
        
        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: white; border: 1px solid #e5e5e5; border-radius: 18px; padding: 20px; text-align: center; }
        .metric-value { font-size: 28px; font-weight: 700; margin: 10px 0; letter-spacing: -1px; }
        .metric-label { font-size: 10px; font-weight: 700; color: #86868b; text-transform: uppercase; display: flex; justify-content: center; align-items: center; }

        .map-section { background: white; border: 1px solid #e5e5e5; border-radius: 24px; padding: 20px; margin-bottom: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
        .map-wrapper { height: 500px; width: 100%; display: block; position: relative; background-image: radial-gradient(#e5e5e5 1px, transparent 1px); background-size: 20px 20px; border-radius: 12px; overflow: hidden; }
        
        details { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        summary { font-size: 12px; font-weight: 600; color: #555; cursor: pointer; outline: none; }
        .explainer-text { font-size: 12px; color: #666; line-height: 1.6; margin-top: 10px; background: #f9f9fa; padding: 15px; border-radius: 8px; }

        .fleet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #fff; padding: 10px 0; border-bottom: 2px solid #f5f5f7; }
        .tabs { background: var(--gray); padding: 4px; border-radius: 10px; display: inline-flex; }
        .tab { padding: 8px 16px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; color: #666; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        .tab.active { background: white; color: black; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .car-card { background: white; border: 1px solid #e5e5e5; border-radius: 16px; padding: 20px; position: relative; transition:0.2s; }
        .car-card.fast { border-bottom: 4px solid var(--green); }
        .car-card.slow { border-bottom: 4px solid var(--brown); }
        .car-card.stopped { border-bottom: 4px solid var(--red); background: #fff5f5; }
        
        .time-badge { position: absolute; top: 15px; right: 15px; background: #000; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; }
        .cong-badge { position: absolute; top: 15px; right: 15px; background: var(--brown); color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; display: none; }
        .stopped .cong-badge { display: block; background: var(--red); }
        .stopped .time-badge { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <h1>GridOS Command</h1>
        <p>IEEE 33-Bus Distribution Feeder Simulation</p>
    </div>

    <div class="dashboard">
        <div class="panel">
            <div style="margin-bottom: 30px;">
                <label>Number of Cars <span class="info-icon" data-tooltip="Simulates load. >100 cars creates high stress.">i</span></label>
                <input type="range" id="numCars" min="1" max="150" value="10" oninput="uiUpdate()">
                <div style="text-align:right; font-weight:700; font-size:12px;"><span id="carsVal">10</span> Vehicles</div>
            </div>
            <div style="margin-bottom: 30px;">
                <label>Solar Array Output <span class="info-icon" data-tooltip="Reduces grid strain.">i</span></label>
                <input type="range" id="solar" min="0" max="100" value="50" oninput="uiUpdate()">
                <div style="text-align:right; font-weight:700; font-size:12px;"><span id="solarVal">50</span>%</div>
            </div>
            <label>Strategy</label>
            <select id="strategy">
                <option value="dumb">Uncontrolled (Standard)</option>
                <option value="smart">Smart Queueing (Optimized)</option>
            </select>
            <button class="run-btn" onclick="runSim()">SYNC NETWORK</button>
            <div style="margin-top:30px; font-size:11px; color:#888;" id="log">System Ready.</div>
        </div>

        <div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Grid Battery <span class="info-icon" data-tooltip="Current charge level of grid storage.">i</span></div>
                    <div class="metric-value"><span id="battLevel">80</span>%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Net Flow <span class="info-icon" data-tooltip="Negative = Draining Battery. Positive = Charging.">i</span></div>
                    <div class="metric-value"><span id="netFlow">0</span></div>
                    <div style="font-size:10px; color:#888;">Megawatts</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Solar Gen <span class="info-icon" data-tooltip="Current renewable output.">i</span></div>
                    <div class="metric-value"><span id="solarMW">0</span></div>
                    <div style="font-size:10px; color:#888;">Megawatts</div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Transf. Temp <span class="info-icon" data-tooltip=">100°C: Overheating Warning. >200°C: CATASTROPHIC FAILURE.">i</span></div>
                    <div class="metric-value" id="tempDisplay" style="color:var(--green)">45°C</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Grid Life <span class="info-icon" data-tooltip="Time until battery empty or full.">i</span></div>
                    <div class="metric-value" id="timeEst" style="font-size:18px;">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">System Status <span class="info-icon" data-tooltip="Operational state.">i</span></div>
                    <div class="metric-value" id="sysStatus" style="font-size:16px;">Stable</div>
                </div>
            </div>

            <div class="map-section">
                <div class="map-title">LIVE FEEDER TOPOLOGY</div>
                <details>
                    <summary>Field Manual: Physics & Constraints</summary>
                    <div class="explainer-text">
                        <strong>Brownout:</strong> If Demand > (Solar + Battery), the grid forces a voltage drop. Cars stop charging to prevent total collapse.
                        <br><strong>Thermodynamics:</strong> Transformers heat up due to load ($I^2R$). Limit: 200°C (Mineral Oil flash point).
                    </div>
                </details>
                <div class="map-wrapper" id="gridMap">
                    <div style="color:#ccc; font-size:13px; text-align:center; padding-top:240px;">Waiting for Sync...</div>
                </div>
            </div>

            <div class="fleet-header">
                <h3>Live Fleet Status</h3>
                <div class="tabs">
                    <div class="tab active" onclick="filterFleet('all', this)">All Vehicles</div>
                    <div class="tab" onclick="filterFleet('charging', this)">Active Charging</div>
                    <div class="tab" onclick="filterFleet('congested', this)">Congested Queue</div>
                </div>
            </div>
            <div class="fleet-grid" id="fleetGrid"></div>
        </div>
    </div>

    <script>
        let fleetData = [];
        let physicsInterval = null;
        let currentBatteryPct = 80;
        let currentNetFlow = 0;
        let currentTemp = 45;
        let isBlackout = false;

        function uiUpdate() {
            document.getElementById('carsVal').innerText = document.getElementById('numCars').value;
            document.getElementById('solarVal').innerText = document.getElementById('solar').value;
        }

        // --- CLIENT SIDE PHYSICS ENGINE ---
        function startLiveTicker() {
            if(physicsInterval) clearInterval(physicsInterval);

            physicsInterval = setInterval(() => {
                if(isBlackout) return;

                // 1. Battery Physics (Visual Interpolation)
                // Drain proportional to flow. 1MW = fast drain.
                let drainSpeed = currentNetFlow * 0.05; 
                currentBatteryPct += drainSpeed;
                if(currentBatteryPct < 0) currentBatteryPct = 0;
                if(currentBatteryPct > 100) currentBatteryPct = 100;
                document.getElementById('battLevel').innerText = currentBatteryPct.toFixed(1);

                // 2. Thermal Physics
                // Heat rises if net flow is heavily negative (Load >> Solar)
                if (currentNetFlow < -1) {
                    currentTemp += 0.5; // Rise!
                } else if (currentTemp > 45) {
                    currentTemp -= 0.2; // Cool
                }
                const tempEl = document.getElementById('tempDisplay');
                tempEl.innerText = currentTemp.toFixed(1) + "°C";
                if(currentTemp > 180) { tempEl.style.color = "var(--red)"; }
                else if(currentTemp > 100) { tempEl.style.color = "var(--orange)"; }
                else { tempEl.style.color = "var(--green)"; }

                // 3. CAR CHARGING ANIMATION
                // Animate bars filling up
                const bars = document.querySelectorAll('.car-bar-fill');
                bars.forEach(bar => {
                    // Only fill if not red (stopped)
                    if (bar.style.backgroundColor !== 'var(--red)') {
                        let w = parseFloat(bar.style.width);
                        if(w < 100) bar.style.width = (w + 0.1) + "%";
                    }
                });

            }, 500); // 2Hz Update Rate
        }

        async function runSim() {
            const btn = document.querySelector('.run-btn');
            btn.innerText = "Simulating...";
            try {
                const res = await fetch('/simulate', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ num_cars: document.getElementById('numCars').value, solar: document.getElementById('solar').value, strategy: document.getElementById('strategy').value })
                });
                const data = await res.json();
                
                // State Update
                currentBatteryPct = data.grid_battery_percent;
                currentNetFlow = data.net_flow_mw;
                currentTemp = data.transformer_temp;
                isBlackout = data.grid_status_text.includes("EXPLODED") || data.grid_status_text.includes("FAILURE");
                
                startLiveTicker();

                // UI
                document.getElementById('solarMW').innerText = data.total_solar_mw.toFixed(2);
                document.getElementById('netFlow').innerText = data.net_flow_mw.toFixed(2);
                const flowEl = document.getElementById('netFlow');
                if(data.net_flow_mw < 0) flowEl.style.color = "var(--red)";
                else flowEl.style.color = "var(--green)";

                document.getElementById('sysStatus').innerText = data.grid_status_text;
                document.getElementById('timeEst').innerText = data.time_estimate;
                document.getElementById('log').innerText = `Last Update: ${data.history[0].time} | Status: ${data.history[0].status}`;
                
                document.body.className = ""; 
                if (isBlackout) {
                    document.body.className = "blackout";
                    document.getElementById('tempDisplay').style.color = "var(--red)";
                }

                const mapData = JSON.parse(data.map);
                if(mapData.data) {
                    document.getElementById('gridMap').innerHTML = ""; 
                    Plotly.newPlot('gridMap', mapData.data, mapData.layout, {displayModeBar: false, responsive: true});
                }
                
                fleetData = data.cars;
                renderFleet(fleetData);
            } catch (e) { console.error(e); }
            btn.innerText = "SYNC NETWORK";
        }
        
        function renderFleet(cars) {
            const grid = document.getElementById('fleetGrid');
            grid.innerHTML = "";
            if(cars.length === 0) { grid.innerHTML = "<div style='color:#999; padding:20px; font-size:13px;'>No vehicles found.</div>"; return; }
            
            cars.forEach(c => {
                let badgeHTML = "";
                let colorClass = "var(--green)";
                if (c.status === 'stopped') {
                    badgeHTML = `<div class="cong-badge" style="background:var(--red); display:block;">GRID FAILURE</div>`;
                    colorClass = "var(--red)";
                } else if (c.status === 'slow') {
                    badgeHTML = `<div class="cong-badge" style="display:block; background:var(--brown);">Full in ${c.time_to_full}</div>`;
                    colorClass = "var(--brown)";
                } else {
                    badgeHTML = `<div class="time-badge">Full in ${c.time_to_full}</div>`;
                }

                grid.innerHTML += `
                    <div class="car-card ${c.status}">
                        ${badgeHTML}
                        <div style="font-weight:700; font-size:14px; margin-bottom:5px;">${c.model}</div>
                        <div style="font-size:12px; color:#666;">Connected to Bus ${c.bus_loc}</div>
                        <div style="width:100%; height:4px; background:#eee; margin-top:10px; border-radius:2px;">
                            <div class="car-bar-fill" style="height:100%; width:${c.soc}%; background:${colorClass}; transition: width 0.5s;"></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:10px; color:#888;">
                            <span>${c.soc}% Battery</span>
                            <span>${c.rate.toFixed(1)} kW</span>
                        </div>
                    </div>`;
            });
        }
        
        function filterFleet(type, btn) {
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(type === 'all') renderFleet(fleetData);
            else if (type === 'charging') renderFleet(fleetData.filter(c => c.status === 'charging' || c.status === 'slow'));
            else if (type === 'congested') renderFleet(fleetData.filter(c => c.status === 'stopped' || c.penalty > 0));
        }
    </script>
</body>
</html>